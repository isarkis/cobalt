name: Build Cobalt
description: Builds Cobalt targets
runs:
  using: "composite"
  steps:
    - run: |
           echo "PYTHONPATH=$GITHUB_WORKSPACE" >> $GITHUB_ENV
      shell: bash
    - run: env | sort
      shell: bash
    - run: |
          gn gen $GITHUB_WORKSPACE/out/${{matrix.target_platform}}_${{matrix.config}} --args="target_platform=\"${{matrix.target_platform}}\" ${{matrix.use_asan}} ${{matrix.is_clang}} ${{matrix.using_old_compiler}} ${{matrix.sb_api_version}} ${{matrix.target_os}} ${{matrix.target_cpu}} is_internal_build=false build_type=\"${{matrix.config}}\""
      shell: bash
    - run: |
        gn check $GITHUB_WORKSPACE/out/${{ matrix.target_platform }}_${{ matrix.config }}
      shell: bash
    - run: |
           set -x
           ln -s /root/starboard-toolchains /github/home/starboard-toolchains
           target=all
           if [[ "${{ matrix.config }}" =~ ^(qa|gold)$ ]]; then
             target=default
           fi
           ninja -v -C ${GITHUB_WORKSPACE}/out/${{ matrix.target_platform }}_${{ matrix.config }} ${target}
      env:
         # BUILD_ID_SERVER_URL:
         IS_CI: 1
         IS_DOCKER: 1
         NINJA_STATUS: '[%e sec | %f/%t %u remaining | %c/sec | j%r]'
         SCCACHE: 1
         SCCACHE_GCS_BUCKET: cobalt-actions-devel-sccache-linux
         SCCACHE_GCS_OAUTH_URL: http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token
         SCCACHE_GCS_RW_MODE: READ_WRITE
         STARBOARD_TOOLCHAINS_DIR: /root/starboard-toolchains 
      shell: bash
